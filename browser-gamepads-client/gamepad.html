<!DOCTYPE html>
<html>

<head>
    <title>Joystick Controls</title>
    <style>
    body
    {
        font-family: Courier, monospaced;
        font-size: 16px;
        font-weight: bold;
    }
    </style>
</head>

<body>

Joystick Controls.
<hr>
<div class="status-text">
    <div id="status1" style="color: red;">Joystick 1</div>
    <div id="status2" style="color: blue;">Joystick 2</div>
    <div id="button1">Button 1</div>

    <div id="button2">button2</div>
    <div id="button3">button3</div>
    <div id="button4">button4</div>

    <div id="button5">button5</div>
    <div id="button6">button6</div>
    <div id="button7">button7</div>
    <div id="button8">button8</div>

    <div id="button9">button9</div>
    <div id="button10">button10</div>

    <div id="button11">button11</div>
    <div id="button12">button12</div>
    <div id="button13">button13</div>

    <div id="gamepad-data">gamepad data</div>
    <button onclick="promptChosenName()">Set your Chosen Name</button>
    <button onclick="setupWebSocket()">Connect to Server</button>
    <button onclick="promptServerName()">Change Server name</button>
</div>

<hr>
<div style="border: 1px solid rgb(5, 4, 4); width: 128px; position: absolute; left:10px; top:150px;">
    <img src="images/joystick-base.png"/>
    <div id="stick1" style="position: absolute; left:32px; top:32px;">
    <img src="images/joystick-red.png"/>		
    </div>
</div>

<div style="border: 1px solid blue; width: 128px; position: absolute; left:210px; top:150px;">
    <img src="images/joystick-base.png"/>
    <div id="stick2" style="position: absolute; left:32px; top:32px;">
    <img src="images/joystick-blue.png"/>		
    </div>
</div>

<button class="bg-green text-white circular-shape" style="position:absolute; left: 10px; top: 300px;" id="button-a">A</button>
<button class="bg-red text-white circular-shape" style="position:absolute; left: 100px; top: 300px;" id="button-b">B</button>
<button class="bg-blue text-white circular-shape" style="position:absolute; left: 190px; top: 300px;" id="button-x">X</button>
<button class="bg-yellow circular-shape" style="position:absolute; left: 280px; top: 300px;" id="button-y">Y</button>

<button class="bg-grey rectangular-shape" style="position:absolute; left: 10px; top: 390px;" id="button-lb">LB</button>
<button class="bg-grey rectangular-shape" style="position:absolute; left: 100px; top: 390px;" id="button-rb">RB</button>
<button class="bg-grey rectangular-shape" style="position:absolute; left: 190px; top: 390px;" id="button-lt">LT</button>
<button class="bg-grey rectangular-shape" style="position:absolute; left: 280px; top: 390px;" id="button-rt">RT</button>

<button class="bg-grey circular-shape" style="position:absolute; left: 10px; top: 480px;" id="button-left-stick">LS</button>
<button class="bg-grey circular-shape" style="position:absolute; left: 100px; top: 480px;" id="button-right-stick">RS</button>
<button class="bg-grey rectangular-shape-small" style="position:absolute; left: 190px; top: 480px;" id="button-back">back</button>
<button class="bg-grey rectangular-shape-small" style="position:absolute; left: 280px; top: 480px;" id="button-start">start</button>
<button class="bg-grey circular-shape" style="position:absolute; left: 10px; top: 570px;" id="button-guide">O</button>

<style>
    .status-text {
        margin-left: 360px;
    }
    .large-button {
        height:60px;
        width: 80px;
        font-size: 40px;
    }
    .circular-shape {
        height:80px;
        width: 80px;
        font-size: 40px;
        border-radius: 50%;
    }
    .rectangular-shape {
        height:60px;
        width: 80px;
        font-size: 40px;
        border-radius: 10%;
    }
    .rectangular-shape-small {
        height:50px;
        width: 80px;
        font-size: 30px;
        border-radius: 10%;
    }
    .text-white { color: white; }
    .bg-green { background-color: green; }
    .bg-red   { background-color: red;}
    .bg-blue { background-color: blue; }
    .bg-yellow { background-color: yellow; }
    .bg-grey { background-color: grey; }

    .bg-green:hover .bg-green:active {background-color: lightgreen;}
    .bg-green:active {background-color: lightgreen;}
    .bg-blue:hover .bg-blue:active {background-color: lightblue;}
    .bg-blue:active {background-color: lightblue;}
    .bg-red:hover .bg-red:active {background-color: lightred;}
    .bg-red:active {background-color: rgb(255, 122, 122);}
    .bg-yellow:hover .bg-yellow:active {background-color: lightyellow;}
    .bg-yellow:active {background-color: lightyellow;}

    .bg-grey:hover .bg-grey:active {background-color: lightgrey;}
    .bg-grey:active {background-color: lightgrey;}
</style>

<script>

class JoystickController
{
    // stickID: ID of HTML element (representing joystick) that will be dragged
    // maxDistance: maximum amount joystick can move in any direction
    // deadzone: joystick must move at least this amount from origin to register value change
    constructor( stickID, maxDistance, deadzone )
    {
        this.id = stickID;
        let stick = document.getElementById(stickID);

        // location from which drag begins, used to calculate offsets
        this.dragStart = null;

        // track touch identifier in case multiple joysticks present
        this.touchId = null;
        
        this.active = false;
        this.value = { x: 0, y: 0 }; 

        let self = this;

        function handleDown(event)
        {
            self.active = true;

            // all drag movements are instantaneous
            stick.style.transition = '0s';

            // touch event fired before mouse event; prevent redundant mouse event from firing
            event.preventDefault();

            if (event.changedTouches)
                self.dragStart = { x: event.changedTouches[0].clientX, y: event.changedTouches[0].clientY };
            else
                self.dragStart = { x: event.clientX, y: event.clientY };

            // if this is a touch event, keep track of which one
            if (event.changedTouches)
                self.touchId = event.changedTouches[0].identifier;
        }
        
        function handleMove(event) 
        {
            if ( !self.active ) return;

            // if this is a touch event, make sure it is the right one
            // also handle multiple simultaneous touchmove events
            let touchmoveId = null;
            if (event.changedTouches)
            {
                for (let i = 0; i < event.changedTouches.length; i++)
                {
                    if (self.touchId == event.changedTouches[i].identifier)
                    {
                        touchmoveId = i;
                        event.clientX = event.changedTouches[i].clientX;
                        event.clientY = event.changedTouches[i].clientY;
                    }
                }

                if (touchmoveId == null) return;
            }

            const xDiff = event.clientX - self.dragStart.x;
            const yDiff = event.clientY - self.dragStart.y;
            const angle = Math.atan2(yDiff, xDiff);
            const distance = Math.min(maxDistance, Math.hypot(xDiff, yDiff));
            const xPosition = distance * Math.cos(angle);
            const yPosition = distance * Math.sin(angle);

            // move stick image to new position
            stick.style.transform = `translate3d(${xPosition}px, ${yPosition}px, 0px)`;

            // deadzone adjustment
            const distance2 = (distance < deadzone) ? 0 : maxDistance / (maxDistance - deadzone) * (distance - deadzone);
            const xPosition2 = distance2 * Math.cos(angle);
            const yPosition2 = distance2 * Math.sin(angle);
            const xPercent = parseFloat((xPosition2 / maxDistance).toFixed(4));
            const yPercent = parseFloat((yPosition2 / maxDistance).toFixed(4));
            
            self.value = { x: xPercent, y: yPercent };
          }

        function handleUp(event) 
        {
            if ( !self.active ) return;

            // if this is a touch event, make sure it is the right one
            if (event.changedTouches && self.touchId != event.changedTouches[0].identifier) return;

            // transition the joystick position back to center
            stick.style.transition = '.2s';
            stick.style.transform = `translate3d(0px, 0px, 0px)`;

            // reset everything
            self.value = { x: 0, y: 0 };
            self.touchId = null;
            self.active = false;
        }

        stick.addEventListener('mousedown', handleDown);
        stick.addEventListener('touchstart', handleDown);
        document.addEventListener('mousemove', handleMove, {passive: false});
        document.addEventListener('touchmove', handleMove, {passive: false});
        document.addEventListener('mouseup', handleUp);
        document.addEventListener('touchend', handleUp);
    }
}

let joystick1 = new JoystickController("stick1", 64, 8);
let joystick2 = new JoystickController("stick2", 64, 8);

class ButtonController {
    constructor( buttonID ) {
        this.id = buttonID;
        let button = document.getElementById(buttonID);

        this.active = false;
        this.touchId = null;
        let self = this;
        function handleDown(event)
        {
            self.active = true;
            event.preventDefault();

            // if this is a touch event, keep track of which one
            if (event.changedTouches)
                self.touchId = event.changedTouches[0].identifier;
        }
        function handleUp(event)
        {
            if ( !self.active ) return;
            
            // if this is a touch event, make sure it is the right one
            if (event.changedTouches && self.touchId != event.changedTouches[0].identifier) return;
            self.touchId = null;
            self.active = false;
        }
        button.addEventListener('mousedown', handleDown);
        button.addEventListener('touchstart', handleDown);
        document.addEventListener('mouseup',handleUp);
        document.addEventListener('touchend', handleUp);

    }
    isActive() {
        return this.active
    }
}

let button1 = new ButtonController("button-a")
let button2 = new ButtonController("button-b")
let button3 = new ButtonController("button-x")
let button4 = new ButtonController("button-y")

let button5 = new ButtonController("button-lb")
let button6 = new ButtonController("button-lt")
let button7 = new ButtonController("button-rb")
let button8 = new ButtonController("button-rt")

let button9 = new ButtonController("button-left-stick")
let button10 = new ButtonController("button-right-stick")

let button11 = new ButtonController("button-back")
let button12 = new ButtonController("button-start")
let button13 = new ButtonController("button-guide")

function getButtonData() {
    return {
        'a': button1.isActive() ? 1 : 0,
        'b': button2.isActive() ? 1 : 0,
        'x': button3.isActive() ? 1 : 0,
        'y': button4.isActive() ? 1 : 0,

        'lb': button5.isActive() ? 1 : 0,
        'lt': button6.isActive() ? 32000 : 0,
        'rb': button7.isActive() ? 1 : 0,
        'rt': button8.isActive() ? 32000 : 0,

        'lc': button9.isActive() ? 1 : 0,
        'rc': button10.isActive() ? 1 : 0,

        'bk': button11.isActive() ? 1 : 0,
        'st': button12.isActive() ? 1 : 0,
        'gb': button13.isActive() ? 1 : 0,

        'lx': parseInt((joystick1.value.x * 16384) + 16384),
        'ly': parseInt(-(joystick1.value.y * 16384) + 16384),
        'rx': parseInt((joystick2.value.x * 16384) + 16384),
        'ry': parseInt(-(joystick2.value.y * 16384) + 16384),
    }
}
let data = {}
function update()
{
    document.getElementById("status1").innerText = "Joystick 1: " + JSON.stringify(joystick1.value);
    document.getElementById("status2").innerText = "Joystick 2: " + JSON.stringify(joystick2.value);

    document.getElementById("button1").innerText = "button1: " + button1.isActive();
    document.getElementById("button2").innerText = "button2: " + button2.isActive();
    document.getElementById("button3").innerText = "button3: " + button3.isActive();
    document.getElementById("button4").innerText = "button4: " + button4.isActive();

    document.getElementById("button5").innerText = "button5: " + button5.isActive();
    document.getElementById("button6").innerText = "button6: " + button6.isActive();
    document.getElementById("button7").innerText = "button7: " + button7.isActive();
    document.getElementById("button8").innerText = "button8: " + button8.isActive();

    document.getElementById("button9").innerText = "button9: " + button9.isActive();
    document.getElementById("button10").innerText = "button10: " + button10.isActive();

    document.getElementById("button11").innerText = "button11: " + button11.isActive();
    document.getElementById("button12").innerText = "button12: " + button12.isActive();
    document.getElementById("button13").innerText = "button13: " + button13.isActive();
    
    data = (getButtonData());
    document.getElementById("gamepad-data").innerText = "gamepad data: " + JSON.stringify(data);
    
}
let socket = null;
let brokerUri = 'localhost:5000'
function promptServerName() {
    name = prompt("Choose a name to identify your gamepad:")
    if (name == "null" || !name) {
        name = '';
    } else {
        brokerUri = name;
    }
}
function setupWebSocket() {
    if (socket == null || socket.readyState == socket.CLOSED) {
        try {
            socket = new WebSocket('ws://'+ brokerUri +'/clients');
            socket.onmessage = function(msg) {
            }
            socket.onclose = function(ev) {
                console.log("WebScoket closed.");
            }
            socket.onopen = function(ev) {
                console.log("WebSocket open.")
            }
        } catch (e) {
            socket = null;
        } 
    }
}

let uid = randUID(6); // 6 length hex code
function randInt(a,b) { // a to b inclusive
    return Math.floor(Math.random(new Date().getTime()) * (b - a + 1)) + a
}

function randUID(length) {
    let res = '';
    for (let i = 0; i < length; i++) res += randInt(0, 15).toString(16);
    return res
}

let chosenName = '';
function promptChosenName() {
    name = prompt("Choose a name to identify your gamepad:")
    if (name == "null" || !name) {
        name = '';
    }
    chosenName = name;
}
promptChosenName();

function loop()
{
    setTimeout(function() {
        update();
        if (socket == null || socket.readyState == socket.CLOSED) {
            
        } else if (socket.readyState == socket.OPEN) { // socket open and connected
            socket.send(JSON.stringify({'ID': chosenName, 'gamepad':data}));
        }
        requestAnimationFrame(loop);
    }, 100);
}

(function(){

})();

loop();

</script>

</body>
</html>